# Slacké€šçŸ¥è¨­å®š

## æ¦‚è¦

akatsukiã®è³¼å…¥å‡¦ç†ã«é–¢ã™ã‚‹Slacké€šçŸ¥ã®è¨­å®šã¨ä»•æ§˜ã§ã™ã€‚

---

## é€šçŸ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°

| ã‚¤ãƒ™ãƒ³ãƒˆ | ãƒãƒ£ãƒ³ãƒãƒ« | å†…å®¹ |
|---------|-----------|------|
| è³¼å…¥é–‹å§‹ | ops | å¯¾è±¡æ—¥ä»˜ã€è²·ã„ç›®æ•° |
| è³¼å…¥å®Œäº† | ops | åˆè¨ˆé‡‘é¡ã€è³¼å…¥ãƒ¬ãƒ¼ã‚¹æ•° |
| ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ | alerts | ã‚¨ãƒ©ãƒ¼å†…å®¹ã€ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ |

---

## ãƒãƒ£ãƒ³ãƒãƒ«è¨­å®š

### Secrets Manager

ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå: `jrdb-main/slack`

```json
{
  "bot_token": "xoxb-...",
  "channel_id": "C090G4U1LTW",
  "alerts_channel_id": "C090G4SEA8L"
}
```

| ã‚­ãƒ¼ | èª¬æ˜ | ç”¨é€” |
|------|------|------|
| bot_token | Slack Bot Token | APIèªè¨¼ |
| channel_id | é‹ç”¨ãƒãƒ£ãƒ³ãƒãƒ«ID | é€šå¸¸é€šçŸ¥ |
| alerts_channel_id | ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ID | ã‚¨ãƒ©ãƒ¼é€šçŸ¥ |

---

## é€šçŸ¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

### è³¼å…¥é–‹å§‹

```
ğŸ›’ è³¼å…¥å‡¦ç†é–‹å§‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… å¯¾è±¡æ—¥ä»˜: 2025/11/16
ğŸ¯ è²·ã„ç›®æ•°: 5ä»¶
â° é–‹å§‹æ™‚åˆ»: 10:30:00
```

### è³¼å…¥å®Œäº†

```
âœ… è³¼å…¥å‡¦ç†å®Œäº†
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… å¯¾è±¡æ—¥ä»˜: 2025/11/16
ğŸ’° åˆè¨ˆé‡‘é¡: Â¥5,000
ğŸ‡ è³¼å…¥ãƒ¬ãƒ¼ã‚¹: 3ãƒ¬ãƒ¼ã‚¹
ğŸ“Š è²·ã„ç›®æ•°: 5ä»¶
â±ï¸ å‡¦ç†æ™‚é–“: 2åˆ†30ç§’
```

### ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ

```
ğŸš¨ è³¼å…¥å‡¦ç†ã‚¨ãƒ©ãƒ¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… å¯¾è±¡æ—¥ä»˜: 2025/11/16
âŒ ã‚¨ãƒ©ãƒ¼: Login failed: Session expired
ğŸ“ ç™ºç”Ÿç®‡æ‰€: purchase_handler.py:45
```

---

## ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯

### tenacityè¨­å®š

```python
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10)
)
def send_slack_message(channel: str, text: str) -> bool:
    """Slacké€šçŸ¥é€ä¿¡ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰"""
    response = requests.post(
        "https://slack.com/api/chat.postMessage",
        headers={"Authorization": f"Bearer {bot_token}"},
        json={"channel": channel, "text": text}
    )
    response.raise_for_status()
    return response.json().get("ok", False)
```

### ãƒªãƒˆãƒ©ã‚¤é–“éš”

| è©¦è¡Œ | å¾…æ©Ÿæ™‚é–“ |
|------|---------|
| 1å›ç›® | å³æ™‚ |
| 2å›ç›® | 2ç§’å¾Œ |
| 3å›ç›® | 4ç§’å¾Œ |

---

## SlackServiceã‚¯ãƒ©ã‚¹

### åˆæœŸåŒ–

```python
from lambda.slack_service import SlackService

slack = SlackService()

# è¨­å®šç¢ºèª
print(f"Slack configured: {slack.is_configured()}")
```

### ãƒ¡ã‚½ãƒƒãƒ‰ä¸€è¦§

| ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|---------|------|
| `send_message(text)` | é€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ |
| `send_alert(text)` | ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ã¸é€ä¿¡ |
| `send_purchase_start(date, count)` | è³¼å…¥é–‹å§‹é€šçŸ¥ |
| `send_purchase_complete(date, amount, count)` | è³¼å…¥å®Œäº†é€šçŸ¥ |
| `send_purchase_error(date, error)` | ã‚¨ãƒ©ãƒ¼é€šçŸ¥ |

---

## ç’°å¢ƒå¤‰æ•°

Lambdaç’°å¢ƒå¤‰æ•°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰:

| å¤‰æ•°å | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
|--------|------|-----------|
| SLACK_ENABLED | Slacké€šçŸ¥ã®æœ‰åŠ¹åŒ– | true |
| SLACK_DRY_RUN | é€šçŸ¥ã‚’ãƒ­ã‚°å‡ºåŠ›ã®ã¿ã«ã™ã‚‹ | false |

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### é€šçŸ¥ãŒå±Šã‹ãªã„

**ç¢ºèªäº‹é …**:
1. Secrets Managerã®bot_tokenãŒæ­£ã—ã„ã‹
2. ãƒãƒ£ãƒ³ãƒãƒ«IDãŒæ­£ã—ã„ã‹
3. BotãŒãƒãƒ£ãƒ³ãƒãƒ«ã«æ‹›å¾…ã•ã‚Œã¦ã„ã‚‹ã‹

### æ¨©é™ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: `not_in_channel` ã‚¨ãƒ©ãƒ¼

**å¯¾å‡¦æ³•**:
1. Slackã‚¢ãƒ—ãƒªã®è¨­å®šç”»é¢ã‚’é–‹ã
2. OAuth & Permissions ã§ `chat:write` ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ç¢ºèª
3. ãƒãƒ£ãƒ³ãƒãƒ«ã§Botã‚’æ‹›å¾…: `/invite @bot-name`

### ãƒ¬ãƒ¼ãƒˆåˆ¶é™

**ç—‡çŠ¶**: `rate_limited` ã‚¨ãƒ©ãƒ¼

**å¯¾å‡¦æ³•**:
- çŸ­æ™‚é–“ã«å¤§é‡ã®é€šçŸ¥ã‚’é€ã‚‰ãªã„
- ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã§è‡ªå‹•å¯¾å¿œ
