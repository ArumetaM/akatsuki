# IPAT自動化の注意点

## 概要

IPATへの自動ログイン・購入における技術的な注意点と制限事項です。

---

## 認証フロー

### ログイン手順

```
1. IPATトップページへアクセス
   ↓
2. 加入者番号（INET-ID）入力
   ↓
3. 暗証番号入力
   ↓
4. P-ARS番号入力（2段階認証）
   ↓
5. メインメニューへ遷移
```

### 認証情報

| 項目 | Secrets Managerキー | 説明 |
|------|---------------------|------|
| 加入者番号 | `jra_inet_id` | INET-ID（10桁） |
| 暗証番号 | `jra_user_id` | 4桁数字 |
| P-ARS番号 | `jra_p_ars` | 4桁数字 |

---

## Playwright設定

### ブラウザ起動オプション

```python
browser = await playwright.chromium.launch(
    headless=True,
    args=[
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--single-process'
    ]
)
```

### Lambda環境での制約

- **ヘッドレスモード必須**: GUIなし環境
- **メモリ制限**: 2048MB推奨
- **タイムアウト**: 15分（購入数による）
- **一時ストレージ**: `/tmp`のみ書き込み可能

---

## 購入処理

### 単勝購入フロー

```
1. 「馬券購入」メニュー選択
   ↓
2. 競馬場選択（場コード）
   ↓
3. レース番号選択
   ↓
4. 式別選択（単勝）
   ↓
5. 馬番入力
   ↓
6. 金額入力
   ↓
7. 購入確認
   ↓
8. 購入確定
```

### 購入間隔

連続購入時の推奨間隔:

```python
# 購入後の待機
await page.wait_for_timeout(2000)  # 2秒
```

---

## エラーハンドリング

### リトライ対象

| エラー種別 | リトライ | 理由 |
|-----------|---------|------|
| ネットワークエラー | ○ | 一時的な接続問題 |
| タイムアウト | ○ | ページ読み込み遅延 |
| セッション切れ | ○ | 再ログインで復旧 |
| 認証エラー | × | 認証情報の問題 |
| 残高不足 | × | 入金が必要 |

### セッション管理

```python
# セッション有効時間
SESSION_TIMEOUT = 30 * 60  # 30分

# セッション切れ検知
if "ログイン" in await page.title():
    # 再ログイン処理
    await login(page)
```

---

## 制限事項

### IPAT側の制限

| 項目 | 制限 |
|------|------|
| 1日の購入上限 | 設定による |
| 1回の購入上限 | 100万円 |
| 購入可能時間 | レース発走前まで |
| 同時ログイン | 1セッションのみ |

### 技術的制限

| 項目 | 制限 |
|------|------|
| Lambda実行時間 | 最大15分 |
| メモリ | 2048MB |
| 並列購入 | 非対応（順次処理） |

---

## セキュリティ考慮事項

### 認証情報の管理

- **Secrets Manager**: 認証情報は必ずSecrets Managerで管理
- **環境変数禁止**: Lambda環境変数に認証情報を直接設定しない
- **ログ出力禁止**: 認証情報をログに出力しない

### アクセス制御

```python
# 認証情報取得時のマスキング
logger.info(f"INET-ID: {inet_id[:3]}***")
```

---

## トラブルシューティング

### ログインできない

**症状**: Login failed エラー

**確認事項**:
1. Secrets Managerの認証情報が正しいか
2. IPATアカウントがロックされていないか
3. P-ARS番号が正しいか

### 購入が遅い

**症状**: タイムアウト発生

**対処法**:
- 買い目数を減らす（10件以下推奨）
- Lambda タイムアウトを延長

### 購入失敗

**症状**: 一部の買い目が購入できない

**原因**:
- レース発走後
- 出走取消
- 残高不足
